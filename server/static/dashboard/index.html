<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Ideation Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header>
      <div class="header-left">
        <h1>API Ideation Dashboard</h1>
        <p class="subtitle">
          Last refresh: {{ formatTime(refreshedAt) }}
        </p>
      </div>
      <div class="header-actions">
        <button class="btn" @click="fetchAll">Refresh</button>
        <button class="btn btn-accent" @click="copyPublishedMD">Copy Published MD</button>
        <button class="btn btn-danger" @click="resetCuration">Reset Curation</button>
      </div>
    </header>

    <!-- Stats -->
    <section class="stats-row" v-if="stats">
      <div class="stat-card">
        <span class="stat-label">Total Batches</span>
        <span class="stat-value">{{ stats.total_batches }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Total Ideas</span>
        <span class="stat-value">{{ stats.total_ideas }}</span>
      </div>
      <div class="stat-card" v-for="g in ['S','A','B','C']" :key="g">
        <span class="stat-label">{{ g }} Grade</span>
        <span class="stat-value" :class="'grade-text-' + g">{{ stats.grade_distribution?.[g] || 0 }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Published</span>
        <span class="stat-value published">{{ stats.published_count }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">On Hold</span>
        <span class="stat-value hold">{{ stats.hold_count }}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Last Batch</span>
        <span class="stat-value date">{{ stats.last_batch_date || '-' }}</span>
      </div>
    </section>

    <!-- Filters -->
    <nav class="filters">
      <select v-model="gradeFilter">
        <option value="">All Grades</option>
        <option v-for="g in ['S','A','B','C','D']" :key="g" :value="g">{{ g }}</option>
      </select>
      <select v-model="curationFilter">
        <option value="">All Status</option>
        <option value="published">Published</option>
        <option value="hold">On Hold</option>
        <option value="rejected">Rejected</option>
        <option value="uncurated">Uncurated</option>
      </select>
      <input type="text" v-model="searchQuery" placeholder="Search...">
      <span class="filter-count">{{ filteredIdeas.length }} ideas</span>
    </nav>

    <!-- Idea List -->
    <section class="idea-list">
      <div v-if="loading" class="loading">Loading...</div>
      <div v-else-if="filteredIdeas.length === 0" class="empty">No ideas found.</div>

      <article v-for="idea in filteredIdeas" :key="idea._uid"
               class="idea-card"
               :class="{'card-published': getCuration(idea) === 'published', 'card-hold': getCuration(idea) === 'hold', 'card-rejected': getCuration(idea) === 'rejected'}">

        <div class="idea-header">
          <span class="grade-badge" :class="'grade-' + idea.grade">{{ idea.grade }}</span>
          <h3>{{ idea.service_name || 'Untitled' }}</h3>
          <span class="score">{{ (idea.weighted_score || idea.numrv_score || 0).toFixed(2) }}</span>
        </div>

        <div class="idea-body">
          <p class="field"><strong>Problem:</strong> {{ idea.problem }}</p>
          <p class="field"><strong>Solution:</strong> {{ idea.concept || idea.solution }}</p>
          <p class="field"><strong>Target:</strong> {{ idea.target || idea.target_buyer }}</p>
          <p class="field"><strong>Revenue:</strong> {{ idea.revenue_model }}</p>

          <details v-if="idea.matched_apis && idea.matched_apis.length">
            <summary>APIs ({{ idea.matched_apis.length }}) | Feasibility: {{ idea.feasibility_pct }}%</summary>
            <ul class="api-list">
              <li v-for="api in idea.matched_apis.slice(0, 5)" :key="api.api_id">
                {{ api.name || api.api_id }} ({{ (api.similarity * 100).toFixed(0) }}%)
              </li>
            </ul>
          </details>

          <details v-if="idea.scores">
            <summary>NUMR-V Scores</summary>
            <div class="scores-row">
              <span v-for="(v, k) in idea.scores" :key="k" class="score-chip">{{ k }}={{ v }}</span>
            </div>
          </details>
        </div>

        <div class="idea-actions">
          <button :class="{'active': getCuration(idea) === 'published'}" @click="setCuration(idea, 'published')" title="Publish">Publish</button>
          <button :class="{'active hold-active': getCuration(idea) === 'hold'}" @click="setCuration(idea, 'hold')" title="Hold">Hold</button>
          <button :class="{'active reject-active': getCuration(idea) === 'rejected'}" @click="setCuration(idea, 'rejected')" title="Reject">Reject</button>
          <button class="btn-feedback" @click="sendFeedback(idea, 'like')">+1</button>
          <button class="btn-feedback" @click="sendFeedback(idea, 'dislike')">-1</button>
        </div>
      </article>
    </section>

    <!-- Toast -->
    <div class="toast" v-if="toast" @click="toast = ''">{{ toast }}</div>
  </div>

  <script src="app.js"></script>
</body>
</html>
